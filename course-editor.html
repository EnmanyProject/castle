<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Castle - Course Editor</title>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4a4a8a;
        }

        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: calc(100vh - 70px);
        }

        /* Left Panel - Gimmick Palette */
        .palette-panel {
            background: rgba(0, 0, 0, 0.2);
            border-right: 2px solid #4a4a8a;
            padding: 15px;
            overflow-y: auto;
        }

        .palette-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a4a8a;
        }

        .difficulty-section {
            margin-bottom: 20px;
        }

        .difficulty-label {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .difficulty-label.easy { color: #38ef7d; }
        .difficulty-label.medium { color: #feca57; }
        .difficulty-label.hard { color: #ff6b6b; }

        .gimmick-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gimmick-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .gimmick-item:active {
            cursor: grabbing;
        }

        .gimmick-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .gimmick-info {
            flex: 1;
        }

        .gimmick-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .gimmick-desc {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 2px;
        }

        /* Center Panel - Track View */
        .track-panel {
            padding: 20px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.1);
        }

        .course-meta {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .meta-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .meta-field label {
            font-size: 0.8rem;
            color: #aaa;
        }

        .meta-field input, .meta-field select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4a4a8a;
            border-radius: 4px;
            padding: 8px;
            color: white;
        }

        .track-view {
            background: linear-gradient(180deg, #2d3436 0%, #636e72 100%);
            border-radius: 10px;
            min-height: 500px;
            position: relative;
            padding: 10px;
            border: 2px dashed #4a4a8a;
        }

        .track-header {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .track-empty {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .track-empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .gimmick-block {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .gimmick-block:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .gimmick-block.selected {
            border-left-color: #48dbfb;
            background: rgba(72, 219, 251, 0.2);
        }

        .gimmick-block.easy { border-left-color: #38ef7d; }
        .gimmick-block.medium { border-left-color: #feca57; }
        .gimmick-block.hard { border-left-color: #ff6b6b; }

        .gimmick-block-icon {
            font-size: 1.3rem;
            width: 35px;
            text-align: center;
        }

        .gimmick-block-info {
            flex: 1;
        }

        .gimmick-block-name {
            font-weight: 600;
        }

        .gimmick-block-params {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 3px;
        }

        .gimmick-block-z {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .gimmick-block-actions {
            display: flex;
            gap: 5px;
        }

        .gimmick-block-actions button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .gimmick-block-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .gimmick-block-actions .delete-btn:hover {
            background: rgba(255, 107, 107, 0.5);
        }

        /* Right Panel - Properties */
        .properties-panel {
            background: rgba(0, 0, 0, 0.2);
            border-left: 2px solid #4a4a8a;
            padding: 15px;
            overflow-y: auto;
        }

        .properties-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a4a8a;
        }

        .properties-empty {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-group-title {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .property-field {
            margin-bottom: 12px;
        }

        .property-field label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #ccc;
        }

        .property-field input, .property-field select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4a4a8a;
            border-radius: 4px;
            padding: 10px;
            color: white;
            font-size: 0.95rem;
        }

        .property-field input:focus, .property-field select:focus {
            outline: none;
            border-color: #48dbfb;
        }

        .property-field .hint {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .property-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .property-range input[type="range"] {
            flex: 1;
        }

        .property-range .value {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 60px;
            text-align: center;
            font-family: monospace;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 25px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #4a4a8a;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .export-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .export-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .export-code {
            background: #0d0d1a;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #4a4a8a;
        }

        .copy-btn {
            margin-top: 15px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #4a4a8a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a9a;
        }

        /* Drop Zone */
        .track-view.drag-over {
            border-color: #48dbfb;
            background: linear-gradient(180deg, #2d3436 0%, #48dbfb22 100%);
        }

        /* Preview Modal */
        .preview-container {
            position: relative;
            background: linear-gradient(180deg, #87CEEB 0%, #87CEEB 60%, #228B22 60%, #228B22 100%);
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
        }

        .preview-canvas-wrapper {
            width: 100%;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .preview-canvas {
            height: 100%;
            min-width: 100%;
            position: relative;
        }

        .preview-track {
            position: absolute;
            bottom: 80px;
            height: 60px;
            background: linear-gradient(180deg, #555 0%, #333 100%);
            border-top: 4px solid #666;
            border-bottom: 4px solid #222;
        }

        .preview-track-lines {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(90deg, #fff 0px, #fff 30px, transparent 30px, transparent 60px);
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .preview-start {
            position: absolute;
            bottom: 140px;
            left: 30px;
            background: linear-gradient(135deg, #38ef7d, #11998e);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .preview-finish {
            position: absolute;
            bottom: 140px;
            background: linear-gradient(135deg, #f5576c, #f093fb);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .preview-gimmick {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .preview-gimmick:hover {
            transform: scale(1.1);
        }

        .preview-gimmick-icon {
            font-size: 2rem;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }

        .preview-gimmick-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            margin-top: 4px;
        }

        .preview-zone {
            position: absolute;
            bottom: 140px;
            opacity: 0.6;
            border-radius: 4px;
        }

        .preview-zone.slime {
            background: linear-gradient(180deg, #7FFF00 0%, #32CD32 100%);
        }

        .preview-zone.conveyor {
            background: linear-gradient(180deg, #666 0%, #444 100%);
            background-image: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
        }

        .preview-zone.electric {
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
            animation: electric-pulse 0.5s infinite;
        }

        @keyframes electric-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.9; }
        }

        .preview-zone.punching {
            background: linear-gradient(180deg, #DC143C 0%, #8B0000 100%);
        }

        .preview-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .preview-control-btn {
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .preview-control-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .preview-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            z-index: 10;
        }

        .preview-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .legend-icon {
            font-size: 1.2rem;
        }

        /* 3D Preview */
        #preview3DCanvas {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }

        .preview3d-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .preview3d-controls button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4a4a8a;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview3d-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .preview3d-controls button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .preview3d-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
            color: #aaa;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }

        .stat-value {
            font-weight: 600;
            color: #48dbfb;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ° Quiz Castle - Course Editor</h1>
        <div class="header-buttons">
            <button class="btn btn-primary" onclick="newCourse()">ğŸ“„ New</button>
            <button class="btn btn-primary" onclick="loadFromJson()">ğŸ“‚ Load</button>
            <button class="btn btn-warning" onclick="showPreviewModal()">ğŸ‘ï¸ 2D</button>
            <button class="btn btn-warning" onclick="show3DPreview()" style="background: linear-gradient(135deg, #11998e, #38ef7d);">ğŸ® 3D</button>
            <button class="btn btn-success" onclick="showExportModal()">ğŸ’¾ Export</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Left Panel - Gimmick Palette -->
        <div class="palette-panel">
            <div class="palette-title">ğŸ§© Gimmick Palette</div>

            <div class="difficulty-section">
                <div class="difficulty-label easy">â— Easy</div>
                <div class="gimmick-item" draggable="true" data-type="RotatingBar">
                    <div class="gimmick-icon">ğŸ”„</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">íšŒì „ ë§‰ëŒ€</div>
                        <div class="gimmick-desc">ë§ìœ¼ë©´ íŠ•ê²¨ë‚¨</div>
                    </div>
                </div>
                <div class="gimmick-item" draggable="true" data-type="JumpPad">
                    <div class="gimmick-icon">ğŸ”º</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">ì í”„ íŒ¨ë“œ</div>
                        <div class="gimmick-desc">ë°Ÿìœ¼ë©´ ë†’ì´ ì í”„</div>
                    </div>
                </div>
                <div class="gimmick-item" draggable="true" data-type="SlimeZone">
                    <div class="gimmick-icon">ğŸ‘»</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">ìŠ¬ë¼ì„ êµ¬ì—­</div>
                        <div class="gimmick-desc">ë°Ÿìœ¼ë©´ ëŠë ¤ì§</div>
                    </div>
                </div>
            </div>

            <div class="difficulty-section">
                <div class="difficulty-label medium">â— Medium</div>
                <div class="gimmick-item" draggable="true" data-type="PunchingCorridor">
                    <div class="gimmick-icon">ğŸ¥Š</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">í€ì¹­ ë³µë„</div>
                        <div class="gimmick-desc">ê¸€ëŸ¬ë¸Œê°€ í€ì¹˜</div>
                    </div>
                </div>
                <div class="gimmick-item" draggable="true" data-type="QuizGate">
                    <div class="gimmick-icon">ğŸšª</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">í€´ì¦ˆ ê²Œì´íŠ¸</div>
                        <div class="gimmick-desc">ì •ë‹µ ë¬¸ìœ¼ë¡œ í†µê³¼</div>
                    </div>
                </div>
                <div class="gimmick-item" draggable="true" data-type="ConveyorBelt">
                    <div class="gimmick-icon">â¬…ï¸</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">ì»¨ë² ì´ì–´ ë²¨íŠ¸</div>
                        <div class="gimmick-desc">ë’¤ë¡œ ë°€ë¦¼</div>
                    </div>
                </div>
                <div class="gimmick-item" draggable="true" data-type="ElectricFloor">
                    <div class="gimmick-icon">âš¡</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">ì „ê¸° ë°”ë‹¥</div>
                        <div class="gimmick-desc">ì£¼ê¸°ì  ê°ì „</div>
                    </div>
                </div>
            </div>

            <div class="difficulty-section">
                <div class="difficulty-label hard">â— Hard</div>
                <div class="gimmick-item" draggable="true" data-type="Elevator">
                    <div class="gimmick-icon">ğŸ›—</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">ì—˜ë¦¬ë² ì´í„°</div>
                        <div class="gimmick-desc">ì •ë‹µì´ ë¹¨ë¦¬ ì˜¬ë¼ê°</div>
                    </div>
                </div>
                <div class="gimmick-item" draggable="true" data-type="RollingBoulder">
                    <div class="gimmick-icon">ğŸª¨</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">êµ´ëŸ¬ì˜¤ëŠ” ë°”ìœ„</div>
                        <div class="gimmick-desc">ë’¤ì—ì„œ êµ´ëŸ¬ì˜´</div>
                    </div>
                </div>
                <div class="gimmick-item" draggable="true" data-type="DisappearingBridge">
                    <div class="gimmick-icon">â°</div>
                    <div class="gimmick-info">
                        <div class="gimmick-name">ì‚¬ë¼ì§€ëŠ” ë‹¤ë¦¬</div>
                        <div class="gimmick-desc">ë°Ÿìœ¼ë©´ ì‚¬ë¼ì§</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel - Track View -->
        <div class="track-panel">
            <div class="course-meta">
                <div class="meta-field">
                    <label>ì½”ìŠ¤ ì´ë¦„</label>
                    <input type="text" id="courseName" value="My Custom Course" placeholder="ì½”ìŠ¤ ì´ë¦„">
                </div>
                <div class="meta-field">
                    <label>ì œì‘ì</label>
                    <input type="text" id="courseAuthor" value="Anonymous" placeholder="ì œì‘ì ì´ë¦„">
                </div>
                <div class="meta-field">
                    <label>íŠ¸ë™ ê¸¸ì´</label>
                    <input type="number" id="courseLength" value="2000" min="500" max="5000" step="100">
                </div>
                <div class="meta-field">
                    <label>ë‚œì´ë„</label>
                    <select id="courseDifficulty">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">ê¸°ë¯¹:</span>
                    <span class="stat-value" id="gimmickCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">í€´ì¦ˆ:</span>
                    <span class="stat-value" id="quizCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ë§ˆì§€ë§‰ Z:</span>
                    <span class="stat-value" id="lastZ">0</span>
                </div>
            </div>

            <div class="track-view" id="trackView">
                <div class="track-header">ğŸ START (Z: 0) â†’ FINISH (Z: <span id="trackLength">2000</span>) ğŸ¯</div>
                <div id="gimmickList">
                    <div class="track-empty">
                        <div class="track-empty-icon">ğŸ“¦</div>
                        <div>ì™¼ìª½ì—ì„œ ê¸°ë¯¹ì„ ë“œë˜ê·¸í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Properties -->
        <div class="properties-panel">
            <div class="properties-title">âš™ï¸ Properties</div>
            <div id="propertiesContent">
                <div class="properties-empty">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ‘†</div>
                    <div>ê¸°ë¯¹ì„ ì„ íƒí•˜ì—¬<br>ì†ì„±ì„ í¸ì§‘í•˜ì„¸ìš”</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ’¾ Export Course</h2>
                <button class="modal-close" onclick="closeExportModal()">Ã—</button>
            </div>
            <div class="export-tabs">
                <button class="export-tab active" onclick="switchExportTab('lua')">Lua (Roblox)</button>
                <button class="export-tab" onclick="switchExportTab('json')">JSON</button>
            </div>
            <pre class="export-code" id="exportCode"></pre>
            <button class="btn btn-success copy-btn" onclick="copyExportCode()">ğŸ“‹ Copy to Clipboard</button>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal" style="max-width: 95%; width: 1200px;">
            <div class="modal-header">
                <h2>ğŸ‘ï¸ Course Preview</h2>
                <button class="modal-close" onclick="closePreviewModal()">Ã—</button>
            </div>
            <div class="preview-container" id="previewContainer">
                <div class="preview-info">
                    <span id="previewCourseName">My Course</span> |
                    <span id="previewGimmickCount">0</span> gimmicks
                </div>
                <div class="preview-controls">
                    <button class="preview-control-btn" onclick="zoomPreview(-1)" title="Zoom Out">âˆ’</button>
                    <button class="preview-control-btn" onclick="zoomPreview(1)" title="Zoom In">+</button>
                    <button class="preview-control-btn" onclick="resetPreviewZoom()" title="Reset">âŸ²</button>
                </div>
                <div class="preview-canvas-wrapper" id="previewWrapper">
                    <div class="preview-canvas" id="previewCanvas">
                        <!-- Track -->
                        <div class="preview-track" id="previewTrack">
                            <div class="preview-track-lines"></div>
                        </div>
                        <!-- Start/Finish markers -->
                        <div class="preview-start">ğŸ START</div>
                        <div class="preview-finish" id="previewFinish">ğŸ¯ FINISH</div>
                        <!-- Gimmicks will be rendered here -->
                        <div id="previewGimmicks"></div>
                    </div>
                </div>
            </div>
            <div class="preview-legend">
                <div class="legend-item"><span class="legend-icon">ğŸ”„</span> íšŒì „ ë§‰ëŒ€</div>
                <div class="legend-item"><span class="legend-icon">ğŸ”º</span> ì í”„ íŒ¨ë“œ</div>
                <div class="legend-item"><span class="legend-icon">ğŸ‘»</span> ìŠ¬ë¼ì„</div>
                <div class="legend-item"><span class="legend-icon">ğŸ¥Š</span> í€ì¹­ ë³µë„</div>
                <div class="legend-item"><span class="legend-icon">ğŸšª</span> í€´ì¦ˆ ê²Œì´íŠ¸</div>
                <div class="legend-item"><span class="legend-icon">ğŸ›—</span> ì—˜ë¦¬ë² ì´í„°</div>
                <div class="legend-item"><span class="legend-icon">â¬…ï¸</span> ì»¨ë² ì´ì–´</div>
                <div class="legend-item"><span class="legend-icon">âš¡</span> ì „ê¸° ë°”ë‹¥</div>
                <div class="legend-item"><span class="legend-icon">ğŸª¨</span> ë°”ìœ„</div>
                <div class="legend-item"><span class="legend-icon">â°</span> ì‚¬ë¼ì§€ëŠ” ë‹¤ë¦¬</div>
            </div>
        </div>
    </div>

    <!-- 3D Preview Modal -->
    <div class="modal-overlay" id="preview3DModal">
        <div class="modal" style="max-width: 95%; width: 1400px;">
            <div class="modal-header">
                <h2>ğŸ® 3D Course Preview</h2>
                <button class="modal-close" onclick="close3DPreview()">Ã—</button>
            </div>
            <div id="preview3DCanvas"></div>
            <div class="preview3d-controls">
                <button onclick="set3DCamera('quarter')" class="active" id="camQuarter">ğŸ¯ ì¿¼í„°ë·°</button>
                <button onclick="set3DCamera('top')" id="camTop">â¬‡ï¸ íƒ‘ë·°</button>
                <button onclick="set3DCamera('side')" id="camSide">â¡ï¸ ì‚¬ì´ë“œë·°</button>
                <button onclick="set3DCamera('first')" id="camFirst">ğŸ‘¤ 1ì¸ì¹­</button>
                <button onclick="toggle3DAnimation()" id="btnAnimate">â–¶ï¸ ì• ë‹ˆë©”ì´ì…˜</button>
                <button onclick="reset3DCamera()">ğŸ”„ ì¹´ë©”ë¼ ë¦¬ì…‹</button>
            </div>
            <div class="preview3d-info">
                ğŸ’¡ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ íšŒì „, ìŠ¤í¬ë¡¤ë¡œ ì¤Œ, ìš°í´ë¦­ ë“œë˜ê·¸ë¡œ ì´ë™
            </div>
        </div>
    </div>

    <script>
        // Gimmick Schema Definitions
        const gimmickSchemas = {
            RotatingBar: {
                displayName: "íšŒì „ ë§‰ëŒ€",
                icon: "ğŸ”„",
                difficulty: "easy",
                fields: {
                    z: { type: "number", min: 0, max: 2000, default: 100, label: "ìœ„ì¹˜ (Z)" },
                    width: { type: "number", min: 10, max: 50, default: 28, label: "ë„ˆë¹„" },
                    height: { type: "number", min: 1, max: 10, default: 3, label: "ë†’ì´" },
                    speed: { type: "number", min: 0.5, max: 5, default: 1.5, label: "íšŒì „ ì†ë„", step: 0.1 }
                }
            },
            JumpPad: {
                displayName: "ì í”„ íŒ¨ë“œ",
                icon: "ğŸ”º",
                difficulty: "easy",
                fields: {
                    x: { type: "number", min: -20, max: 20, default: 0, label: "X ìœ„ì¹˜" },
                    y: { type: "number", min: 0, max: 10, default: 0.5, label: "Y ìœ„ì¹˜", step: 0.5 },
                    z: { type: "number", min: 0, max: 2000, default: 100, label: "Z ìœ„ì¹˜" }
                }
            },
            SlimeZone: {
                displayName: "ìŠ¬ë¼ì„ êµ¬ì—­",
                icon: "ğŸ‘»",
                difficulty: "easy",
                fields: {
                    z: { type: "number", min: 0, max: 2000, default: 100, label: "ì‹œì‘ ìœ„ì¹˜ (Z)" },
                    length: { type: "number", min: 20, max: 200, default: 80, label: "ê¸¸ì´" }
                }
            },
            PunchingCorridor: {
                displayName: "í€ì¹­ ë³µë„",
                icon: "ğŸ¥Š",
                difficulty: "medium",
                fields: {
                    z: { type: "number", min: 0, max: 2000, default: 100, label: "ì‹œì‘ ìœ„ì¹˜ (Z)" },
                    length: { type: "number", min: 50, max: 200, default: 100, label: "ê¸¸ì´" }
                }
            },
            QuizGate: {
                displayName: "í€´ì¦ˆ ê²Œì´íŠ¸",
                icon: "ğŸšª",
                difficulty: "medium",
                fields: {
                    id: { type: "number", min: 1, max: 100, default: 1, label: "ê²Œì´íŠ¸ ID" },
                    triggerZ: { type: "number", min: 0, max: 2000, default: 150, label: "íŠ¸ë¦¬ê±° ìœ„ì¹˜" },
                    gateZ: { type: "number", min: 0, max: 2000, default: 180, label: "ê²Œì´íŠ¸ ìœ„ì¹˜" },
                    options: { type: "select", options: [2, 3, 4], default: 2, label: "ì„ íƒì§€ ìˆ˜" }
                }
            },
            Elevator: {
                displayName: "ì—˜ë¦¬ë² ì´í„°",
                icon: "ğŸ›—",
                difficulty: "hard",
                fields: {
                    id: { type: "number", min: 1, max: 100, default: 1, label: "ì—˜ë¦¬ë² ì´í„° ID" },
                    triggerZ: { type: "number", min: 0, max: 2000, default: 620, label: "íŠ¸ë¦¬ê±° ìœ„ì¹˜" },
                    elevZ: { type: "number", min: 0, max: 2000, default: 670, label: "ì—˜ë¦¬ë² ì´í„° ìœ„ì¹˜" },
                    options: { type: "select", options: [2, 3, 4], default: 3, label: "ì„ íƒì§€ ìˆ˜" }
                }
            },
            ConveyorBelt: {
                displayName: "ì»¨ë² ì´ì–´ ë²¨íŠ¸",
                icon: "â¬…ï¸",
                difficulty: "medium",
                fields: {
                    z: { type: "number", min: 0, max: 2000, default: 100, label: "ì‹œì‘ ìœ„ì¹˜ (Z)" },
                    length: { type: "number", min: 20, max: 200, default: 60, label: "ê¸¸ì´" },
                    direction: { type: "select", options: [-1, 1], optionLabels: ["ë’¤ë¡œ (-1)", "ì•ìœ¼ë¡œ (1)"], default: -1, label: "ë°©í–¥" }
                }
            },
            ElectricFloor: {
                displayName: "ì „ê¸° ë°”ë‹¥",
                icon: "âš¡",
                difficulty: "medium",
                fields: {
                    z: { type: "number", min: 0, max: 2000, default: 100, label: "ì‹œì‘ ìœ„ì¹˜ (Z)" },
                    length: { type: "number", min: 20, max: 200, default: 60, label: "ê¸¸ì´" }
                }
            },
            RollingBoulder: {
                displayName: "êµ´ëŸ¬ì˜¤ëŠ” ë°”ìœ„",
                icon: "ğŸª¨",
                difficulty: "hard",
                fields: {
                    zStart: { type: "number", min: 0, max: 2000, default: 100, label: "ì‹œì‘ ìœ„ì¹˜ (Z)" },
                    zEnd: { type: "number", min: 0, max: 2000, default: 200, label: "ë ìœ„ì¹˜ (Z)" }
                }
            },
            DisappearingBridge: {
                displayName: "ì‚¬ë¼ì§€ëŠ” ë‹¤ë¦¬",
                icon: "â°",
                difficulty: "hard",
                fields: {
                    z: { type: "number", min: 0, max: 2000, default: 100, label: "ì‹œì‘ ìœ„ì¹˜ (Z)" },
                    platformCount: { type: "number", min: 2, max: 20, default: 6, label: "í”Œë«í¼ ìˆ˜" }
                }
            }
        };

        // Course Data
        let courseGimmicks = [];
        let selectedGimmickIndex = -1;
        let gimmickIdCounter = { QuizGate: 0, Elevator: 0 };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupDragAndDrop();
            updateTrackLength();
            document.getElementById('courseLength').addEventListener('change', updateTrackLength);
        });

        function updateTrackLength() {
            const length = document.getElementById('courseLength').value;
            document.getElementById('trackLength').textContent = length;
        }

        function setupDragAndDrop() {
            // Palette items
            document.querySelectorAll('.gimmick-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('gimmickType', item.dataset.type);
                });
            });

            // Track view
            const trackView = document.getElementById('trackView');
            trackView.addEventListener('dragover', (e) => {
                e.preventDefault();
                trackView.classList.add('drag-over');
            });
            trackView.addEventListener('dragleave', () => {
                trackView.classList.remove('drag-over');
            });
            trackView.addEventListener('drop', (e) => {
                e.preventDefault();
                trackView.classList.remove('drag-over');
                const type = e.dataTransfer.getData('gimmickType');
                if (type) {
                    addGimmick(type);
                }
            });
        }

        function addGimmick(type) {
            const schema = gimmickSchemas[type];
            if (!schema) return;

            const gimmick = { type };

            // Calculate next Z position
            let nextZ = 50;
            if (courseGimmicks.length > 0) {
                const lastGimmick = courseGimmicks[courseGimmicks.length - 1];
                const lastZ = getGimmickZ(lastGimmick);
                nextZ = lastZ + 70;
            }

            // Set default values
            for (const [key, field] of Object.entries(schema.fields)) {
                if (key === 'z' || key === 'triggerZ' || key === 'zStart') {
                    gimmick[key] = nextZ;
                    if (key === 'triggerZ' && schema.fields.gateZ) {
                        gimmick.gateZ = nextZ + 30;
                    }
                    if (key === 'triggerZ' && schema.fields.elevZ) {
                        gimmick.elevZ = nextZ + 50;
                    }
                    if (key === 'zStart' && schema.fields.zEnd) {
                        gimmick.zEnd = nextZ + 100;
                    }
                } else if (key === 'id') {
                    gimmickIdCounter[type] = (gimmickIdCounter[type] || 0) + 1;
                    gimmick[key] = gimmickIdCounter[type];
                } else {
                    gimmick[key] = field.default;
                }
            }

            courseGimmicks.push(gimmick);
            sortGimmicksByZ();
            renderGimmickList();
            selectGimmick(courseGimmicks.indexOf(gimmick));
        }

        function getGimmickZ(gimmick) {
            return gimmick.z || gimmick.triggerZ || gimmick.zStart || 0;
        }

        function sortGimmicksByZ() {
            courseGimmicks.sort((a, b) => getGimmickZ(a) - getGimmickZ(b));
        }

        function renderGimmickList() {
            const container = document.getElementById('gimmickList');

            if (courseGimmicks.length === 0) {
                container.innerHTML = `
                    <div class="track-empty">
                        <div class="track-empty-icon">ğŸ“¦</div>
                        <div>ì™¼ìª½ì—ì„œ ê¸°ë¯¹ì„ ë“œë˜ê·¸í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</div>
                    </div>
                `;
                updateStats();
                return;
            }

            container.innerHTML = courseGimmicks.map((gimmick, index) => {
                const schema = gimmickSchemas[gimmick.type];
                const z = getGimmickZ(gimmick);
                const params = Object.entries(gimmick)
                    .filter(([k, v]) => k !== 'type')
                    .map(([k, v]) => `${k}:${v}`)
                    .join(' | ');

                return `
                    <div class="gimmick-block ${schema.difficulty} ${selectedGimmickIndex === index ? 'selected' : ''}"
                         onclick="selectGimmick(${index})">
                        <div class="gimmick-block-icon">${schema.icon}</div>
                        <div class="gimmick-block-info">
                            <div class="gimmick-block-name">${schema.displayName}</div>
                            <div class="gimmick-block-params">${params}</div>
                        </div>
                        <div class="gimmick-block-z">Z: ${z}</div>
                        <div class="gimmick-block-actions">
                            <button onclick="moveGimmick(${index}, -1); event.stopPropagation();">â–²</button>
                            <button onclick="moveGimmick(${index}, 1); event.stopPropagation();">â–¼</button>
                            <button class="delete-btn" onclick="deleteGimmick(${index}); event.stopPropagation();">ğŸ—‘</button>
                        </div>
                    </div>
                `;
            }).join('');

            updateStats();
        }

        function updateStats() {
            document.getElementById('gimmickCount').textContent = courseGimmicks.length;
            document.getElementById('quizCount').textContent = courseGimmicks.filter(g =>
                g.type === 'QuizGate' || g.type === 'Elevator'
            ).length;

            if (courseGimmicks.length > 0) {
                const maxZ = Math.max(...courseGimmicks.map(g => getGimmickZ(g)));
                document.getElementById('lastZ').textContent = maxZ;
            } else {
                document.getElementById('lastZ').textContent = '0';
            }
        }

        function selectGimmick(index) {
            selectedGimmickIndex = index;
            renderGimmickList();
            renderProperties();
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');

            if (selectedGimmickIndex < 0 || selectedGimmickIndex >= courseGimmicks.length) {
                container.innerHTML = `
                    <div class="properties-empty">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ‘†</div>
                        <div>ê¸°ë¯¹ì„ ì„ íƒí•˜ì—¬<br>ì†ì„±ì„ í¸ì§‘í•˜ì„¸ìš”</div>
                    </div>
                `;
                return;
            }

            const gimmick = courseGimmicks[selectedGimmickIndex];
            const schema = gimmickSchemas[gimmick.type];

            let html = `
                <div class="property-group">
                    <div class="property-group-title">${schema.icon} ${schema.displayName}</div>
                </div>
                <div class="property-group">
                    <div class="property-group-title">Parameters</div>
            `;

            for (const [key, field] of Object.entries(schema.fields)) {
                const value = gimmick[key];

                if (field.type === 'select') {
                    const options = field.options.map((opt, i) => {
                        const label = field.optionLabels ? field.optionLabels[i] : opt;
                        return `<option value="${opt}" ${value == opt ? 'selected' : ''}>${label}</option>`;
                    }).join('');

                    html += `
                        <div class="property-field">
                            <label>${field.label}</label>
                            <select onchange="updateGimmickProperty('${key}', this.value)">
                                ${options}
                            </select>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="property-field">
                            <label>${field.label}</label>
                            <div class="property-range">
                                <input type="range"
                                       min="${field.min}"
                                       max="${field.max}"
                                       step="${field.step || 1}"
                                       value="${value}"
                                       oninput="updateGimmickProperty('${key}', this.value); this.nextElementSibling.textContent = this.value;">
                                <span class="value">${value}</span>
                            </div>
                            <div class="hint">ë²”ìœ„: ${field.min} ~ ${field.max}</div>
                        </div>
                    `;
                }
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function updateGimmickProperty(key, value) {
            if (selectedGimmickIndex < 0) return;

            const numValue = parseFloat(value);
            courseGimmicks[selectedGimmickIndex][key] = isNaN(numValue) ? value : numValue;

            sortGimmicksByZ();
            const newIndex = courseGimmicks.findIndex(g => g === courseGimmicks[selectedGimmickIndex]);
            selectedGimmickIndex = newIndex >= 0 ? newIndex : selectedGimmickIndex;

            renderGimmickList();
        }

        function moveGimmick(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= courseGimmicks.length) return;

            [courseGimmicks[index], courseGimmicks[newIndex]] = [courseGimmicks[newIndex], courseGimmicks[index]];

            if (selectedGimmickIndex === index) {
                selectedGimmickIndex = newIndex;
            } else if (selectedGimmickIndex === newIndex) {
                selectedGimmickIndex = index;
            }

            renderGimmickList();
        }

        function deleteGimmick(index) {
            courseGimmicks.splice(index, 1);
            if (selectedGimmickIndex >= courseGimmicks.length) {
                selectedGimmickIndex = courseGimmicks.length - 1;
            }
            renderGimmickList();
            renderProperties();
        }

        function newCourse() {
            if (courseGimmicks.length > 0 && !confirm('í˜„ì¬ ì½”ìŠ¤ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            courseGimmicks = [];
            selectedGimmickIndex = -1;
            gimmickIdCounter = { QuizGate: 0, Elevator: 0 };
            document.getElementById('courseName').value = 'My Custom Course';
            document.getElementById('courseAuthor').value = 'Anonymous';
            renderGimmickList();
            renderProperties();
        }

        function getCourseData() {
            return {
                metadata: {
                    name: document.getElementById('courseName').value,
                    author: document.getElementById('courseAuthor').value,
                    version: "1.0",
                    length: parseInt(document.getElementById('courseLength').value),
                    difficulty: document.getElementById('courseDifficulty').value
                },
                gimmicks: courseGimmicks
            };
        }

        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
            switchExportTab('lua');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        let currentExportTab = 'lua';

        function switchExportTab(tab) {
            currentExportTab = tab;
            document.querySelectorAll('.export-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.export-tab:nth-child(${tab === 'lua' ? 1 : 2})`).classList.add('active');

            const data = getCourseData();
            const codeElement = document.getElementById('exportCode');

            if (tab === 'lua') {
                codeElement.textContent = generateLuaCode(data);
            } else {
                codeElement.textContent = JSON.stringify(data, null, 2);
            }
        }

        function generateLuaCode(data) {
            let lua = `-- ============================================
-- ğŸ“‹ CUSTOM COURSE DATA
-- Generated by Quiz Castle Course Editor
-- ============================================
local CustomCourseData = {
    metadata = {
        name = "${data.metadata.name}",
        author = "${data.metadata.author}",
        version = "${data.metadata.version}",
        length = ${data.metadata.length},
        difficulty = "${data.metadata.difficulty}"
    },
    gimmicks = {\n`;

            for (const gimmick of data.gimmicks) {
                const params = Object.entries(gimmick)
                    .map(([k, v]) => {
                        if (k === 'type') return `type = "${v}"`;
                        return `${k} = ${v}`;
                    })
                    .join(', ');
                lua += `        {${params}},\n`;
            }

            lua += `    }
}

-- Usage: CourseEngine:BuildFromData(parent, CustomCourseData)
return CustomCourseData`;

            return lua;
        }

        function copyExportCode() {
            const code = document.getElementById('exportCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        function loadFromJson() {
            const input = prompt('JSON ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:');
            if (!input) return;

            try {
                const data = JSON.parse(input);
                if (data.metadata) {
                    document.getElementById('courseName').value = data.metadata.name || 'Loaded Course';
                    document.getElementById('courseAuthor').value = data.metadata.author || 'Unknown';
                    document.getElementById('courseLength').value = data.metadata.length || 2000;
                    document.getElementById('courseDifficulty').value = data.metadata.difficulty || 'medium';
                    updateTrackLength();
                }
                if (data.gimmicks) {
                    courseGimmicks = data.gimmicks;
                    // Recalculate ID counters
                    gimmickIdCounter = { QuizGate: 0, Elevator: 0 };
                    courseGimmicks.forEach(g => {
                        if (g.id && gimmickIdCounter[g.type] !== undefined) {
                            gimmickIdCounter[g.type] = Math.max(gimmickIdCounter[g.type], g.id);
                        }
                    });
                }
                selectedGimmickIndex = -1;
                renderGimmickList();
                renderProperties();
                alert('ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
            } catch (e) {
                alert('JSON íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
            }
        }

        // ============================================
        // PREVIEW FUNCTIONALITY
        // ============================================
        let previewScale = 0.5; // pixels per Z unit
        const MIN_SCALE = 0.2;
        const MAX_SCALE = 2;

        function showPreviewModal() {
            document.getElementById('previewModal').classList.add('active');
            renderPreview();
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        function zoomPreview(direction) {
            previewScale += direction * 0.1;
            previewScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, previewScale));
            renderPreview();
        }

        function resetPreviewZoom() {
            previewScale = 0.5;
            renderPreview();
        }

        function renderPreview() {
            const courseLength = parseInt(document.getElementById('courseLength').value) || 2000;
            const canvasWidth = (courseLength + 200) * previewScale;

            // Update info
            document.getElementById('previewCourseName').textContent = document.getElementById('courseName').value;
            document.getElementById('previewGimmickCount').textContent = courseGimmicks.length;

            // Set canvas width
            const canvas = document.getElementById('previewCanvas');
            canvas.style.width = `${Math.max(canvasWidth, 1000)}px`;

            // Set track width
            const track = document.getElementById('previewTrack');
            track.style.left = `${50 * previewScale}px`;
            track.style.width = `${courseLength * previewScale}px`;

            // Position finish marker
            const finish = document.getElementById('previewFinish');
            finish.style.left = `${(courseLength + 30) * previewScale}px`;

            // Render gimmicks
            const gimmicksContainer = document.getElementById('previewGimmicks');
            gimmicksContainer.innerHTML = '';

            courseGimmicks.forEach((gimmick, index) => {
                const schema = gimmickSchemas[gimmick.type];
                if (!schema) return;

                const z = getGimmickZ(gimmick);
                const xPos = (z + 50) * previewScale;

                // Check if it's a zone-type gimmick (has length)
                if (gimmick.length !== undefined || gimmick.zEnd !== undefined) {
                    // Zone gimmicks (SlimeZone, ConveyorBelt, ElectricFloor, PunchingCorridor)
                    const length = gimmick.length || (gimmick.zEnd - gimmick.zStart) || 60;
                    const zone = document.createElement('div');
                    zone.className = 'preview-zone';

                    // Determine zone class
                    if (gimmick.type === 'SlimeZone') zone.classList.add('slime');
                    else if (gimmick.type === 'ConveyorBelt') zone.classList.add('conveyor');
                    else if (gimmick.type === 'ElectricFloor') zone.classList.add('electric');
                    else if (gimmick.type === 'PunchingCorridor') zone.classList.add('punching');
                    else if (gimmick.type === 'RollingBoulder') {
                        zone.style.background = 'linear-gradient(90deg, transparent, rgba(139,69,19,0.5), transparent)';
                    }
                    else if (gimmick.type === 'DisappearingBridge') {
                        zone.style.background = 'rgba(100,100,100,0.5)';
                        zone.style.borderTop = '3px dashed #fff';
                    }

                    zone.style.left = `${xPos}px`;
                    zone.style.width = `${length * previewScale}px`;
                    zone.style.height = '50px';
                    zone.title = `${schema.displayName} (Z: ${z}, ê¸¸ì´: ${length})`;
                    zone.onclick = () => { closePreviewModal(); selectGimmick(index); };

                    // Add label
                    const label = document.createElement('div');
                    label.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5rem;';
                    label.textContent = schema.icon;
                    zone.appendChild(label);

                    gimmicksContainer.appendChild(zone);
                } else {
                    // Point gimmicks (RotatingBar, JumpPad, QuizGate, Elevator)
                    const gimmickEl = document.createElement('div');
                    gimmickEl.className = 'preview-gimmick';
                    gimmickEl.style.left = `${xPos}px`;

                    // Adjust vertical position based on type
                    let bottomPos = 145;
                    if (gimmick.type === 'RotatingBar') {
                        bottomPos = 150 + (gimmick.height || 3) * 5;
                    } else if (gimmick.type === 'JumpPad') {
                        bottomPos = 140;
                    } else if (gimmick.type === 'QuizGate' || gimmick.type === 'Elevator') {
                        bottomPos = 170;
                    }
                    gimmickEl.style.bottom = `${bottomPos}px`;

                    // Tooltip
                    let tooltip = `${schema.displayName} (Z: ${z})`;
                    if (gimmick.id) tooltip += ` #${gimmick.id}`;
                    if (gimmick.options) tooltip += ` [${gimmick.options}ì„ íƒì§€]`;
                    gimmickEl.title = tooltip;

                    gimmickEl.onclick = () => { closePreviewModal(); selectGimmick(index); };

                    // Icon
                    const icon = document.createElement('div');
                    icon.className = 'preview-gimmick-icon';
                    icon.textContent = schema.icon;
                    gimmickEl.appendChild(icon);

                    // Label for QuizGate/Elevator
                    if (gimmick.type === 'QuizGate' || gimmick.type === 'Elevator') {
                        const labelEl = document.createElement('div');
                        labelEl.className = 'preview-gimmick-label';
                        labelEl.textContent = `#${gimmick.id} (${gimmick.options}ê°œ)`;
                        gimmickEl.appendChild(labelEl);
                    }

                    gimmicksContainer.appendChild(gimmickEl);
                }
            });

            // Add Z markers
            for (let z = 0; z <= courseLength; z += 200) {
                const marker = document.createElement('div');
                marker.style.cssText = `
                    position: absolute;
                    bottom: 60px;
                    left: ${(z + 50) * previewScale}px;
                    transform: translateX(-50%);
                    font-size: 0.7rem;
                    color: rgba(255,255,255,0.7);
                    background: rgba(0,0,0,0.5);
                    padding: 2px 6px;
                    border-radius: 3px;
                `;
                marker.textContent = `Z:${z}`;
                gimmicksContainer.appendChild(marker);
            }
        }

        // ============================================
        // 3D PREVIEW (Three.js)
        // ============================================
        let scene3D, camera3D, renderer3D, controls3D;
        let animating3D = false;
        let animationId = null;
        let gimmickMeshes = [];
        const SCALE_3D = 0.05; // Scale factor for 3D view

        // 3D Colors
        const COLORS_3D = {
            track: 0x444444,
            trackLine: 0xffffff,
            sky: 0x87CEEB,
            grass: 0x228B22,
            rotatingBar: 0xff4444,
            jumpPad: 0x44ff44,
            slime: 0x7FFF00,
            quizGate: 0x4444ff,
            elevator: 0x8844ff,
            conveyor: 0x666666,
            electric: 0xFFD700,
            punching: 0xDC143C,
            boulder: 0x8B4513,
            bridge: 0x888888,
            start: 0x00ff00,
            finish: 0xff0000
        };

        function show3DPreview() {
            document.getElementById('preview3DModal').classList.add('active');
            init3DScene();
            render3DCourse();
            animate3D();
        }

        function close3DPreview() {
            document.getElementById('preview3DModal').classList.remove('active');
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            if (renderer3D) {
                renderer3D.dispose();
                const canvas = document.getElementById('preview3DCanvas');
                canvas.innerHTML = '';
            }
        }

        function init3DScene() {
            const container = document.getElementById('preview3DCanvas');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = 500;

            // Scene
            scene3D = new THREE.Scene();
            scene3D.background = new THREE.Color(0x87CEEB);
            scene3D.fog = new THREE.Fog(0x87CEEB, 50, 200);

            // Camera
            camera3D = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);

            // Renderer
            renderer3D = new THREE.WebGLRenderer({ antialias: true });
            renderer3D.setSize(width, height);
            renderer3D.shadowMap.enabled = true;
            renderer3D.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer3D.domElement);

            // Controls
            controls3D = new THREE.OrbitControls(camera3D, renderer3D.domElement);
            controls3D.enableDamping = true;
            controls3D.dampingFactor = 0.05;
            controls3D.maxPolarAngle = Math.PI / 2;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene3D.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            scene3D.add(directionalLight);

            // Set quarter view camera
            set3DCamera('quarter');
        }

        function render3DCourse() {
            // Clear previous gimmicks
            gimmickMeshes.forEach(mesh => scene3D.remove(mesh));
            gimmickMeshes = [];

            const courseLength = parseInt(document.getElementById('courseLength').value) || 2000;
            const trackLength = courseLength * SCALE_3D;
            const trackWidth = 30 * SCALE_3D;

            // Ground (grass)
            const groundGeometry = new THREE.PlaneGeometry(trackWidth * 3, trackLength + 20);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: COLORS_3D.grass });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.set(0, -0.1, trackLength / 2);
            ground.receiveShadow = true;
            scene3D.add(ground);
            gimmickMeshes.push(ground);

            // Track
            const trackGeometry = new THREE.BoxGeometry(trackWidth, 0.2, trackLength);
            const trackMaterial = new THREE.MeshLambertMaterial({ color: COLORS_3D.track });
            const track = new THREE.Mesh(trackGeometry, trackMaterial);
            track.position.set(0, 0, trackLength / 2);
            track.receiveShadow = true;
            scene3D.add(track);
            gimmickMeshes.push(track);

            // Track lines
            const lineGeometry = new THREE.BoxGeometry(0.05, 0.01, trackLength);
            const lineMaterial = new THREE.MeshBasicMaterial({ color: COLORS_3D.trackLine });
            const centerLine = new THREE.Mesh(lineGeometry, lineMaterial);
            centerLine.position.set(0, 0.11, trackLength / 2);
            scene3D.add(centerLine);
            gimmickMeshes.push(centerLine);

            // Start marker
            const startGeometry = new THREE.BoxGeometry(trackWidth, 0.5, 0.2);
            const startMaterial = new THREE.MeshLambertMaterial({ color: COLORS_3D.start });
            const startMarker = new THREE.Mesh(startGeometry, startMaterial);
            startMarker.position.set(0, 0.25, 0);
            scene3D.add(startMarker);
            gimmickMeshes.push(startMarker);

            // Finish marker
            const finishGeometry = new THREE.BoxGeometry(trackWidth, 3, 0.2);
            const finishMaterial = new THREE.MeshLambertMaterial({ color: COLORS_3D.finish });
            const finishMarker = new THREE.Mesh(finishGeometry, finishMaterial);
            finishMarker.position.set(0, 1.5, trackLength);
            scene3D.add(finishMarker);
            gimmickMeshes.push(finishMarker);

            // Render each gimmick
            courseGimmicks.forEach((gimmick, index) => {
                const mesh = create3DGimmick(gimmick, index);
                if (mesh) {
                    scene3D.add(mesh);
                    gimmickMeshes.push(mesh);
                }
            });

            // Update controls target
            controls3D.target.set(0, 1, trackLength / 2);
            controls3D.update();
        }

        function create3DGimmick(gimmick, index) {
            const z = (gimmick.z || gimmick.triggerZ || gimmick.zStart || 0) * SCALE_3D;
            let mesh;

            switch (gimmick.type) {
                case 'RotatingBar': {
                    const width = (gimmick.width || 28) * SCALE_3D;
                    const height = (gimmick.height || 3) * SCALE_3D;
                    const geometry = new THREE.BoxGeometry(width, 0.15, 0.15);
                    const material = new THREE.MeshLambertMaterial({ color: COLORS_3D.rotatingBar });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(0, height, z);
                    mesh.castShadow = true;
                    mesh.userData = { type: 'rotating', speed: gimmick.speed || 1.5 };
                    break;
                }

                case 'JumpPad': {
                    const geometry = new THREE.CylinderGeometry(0.4, 0.5, 0.1, 8);
                    const material = new THREE.MeshLambertMaterial({ color: COLORS_3D.jumpPad });
                    mesh = new THREE.Mesh(geometry, material);
                    const x = (gimmick.x || 0) * SCALE_3D;
                    mesh.position.set(x, 0.15, z);
                    mesh.castShadow = true;
                    break;
                }

                case 'SlimeZone': {
                    const length = (gimmick.length || 80) * SCALE_3D;
                    const geometry = new THREE.BoxGeometry(1.4, 0.05, length);
                    const material = new THREE.MeshLambertMaterial({
                        color: COLORS_3D.slime,
                        transparent: true,
                        opacity: 0.7
                    });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(0, 0.12, z + length/2);
                    break;
                }

                case 'QuizGate': {
                    const group = new THREE.Group();
                    const options = gimmick.options || 2;
                    const gateWidth = 1.4 / options;

                    for (let i = 0; i < options; i++) {
                        // Gate frame
                        const frameGeometry = new THREE.BoxGeometry(gateWidth - 0.05, 1.2, 0.1);
                        const frameMaterial = new THREE.MeshLambertMaterial({
                            color: i === 0 ? 0x00ff00 : COLORS_3D.quizGate
                        });
                        const frame = new THREE.Mesh(frameGeometry, frameMaterial);
                        frame.position.x = (i - (options-1)/2) * gateWidth;
                        frame.position.y = 0.6;
                        frame.castShadow = true;
                        group.add(frame);
                    }

                    const gateZ = (gimmick.gateZ || gimmick.triggerZ + 30) * SCALE_3D;
                    group.position.set(0, 0, gateZ);
                    mesh = group;
                    break;
                }

                case 'Elevator': {
                    const group = new THREE.Group();
                    const options = gimmick.options || 3;
                    const platWidth = 1.4 / options;

                    for (let i = 0; i < options; i++) {
                        const platGeometry = new THREE.BoxGeometry(platWidth - 0.05, 0.15, 0.6);
                        const platMaterial = new THREE.MeshLambertMaterial({
                            color: i === 0 ? 0x00ff00 : COLORS_3D.elevator
                        });
                        const plat = new THREE.Mesh(platGeometry, platMaterial);
                        plat.position.x = (i - (options-1)/2) * platWidth;
                        plat.position.y = 0.15;
                        plat.castShadow = true;
                        group.add(plat);
                    }

                    const elevZ = (gimmick.elevZ || gimmick.triggerZ + 50) * SCALE_3D;
                    group.position.set(0, 0, elevZ);
                    mesh = group;
                    break;
                }

                case 'ConveyorBelt': {
                    const length = (gimmick.length || 60) * SCALE_3D;
                    const geometry = new THREE.BoxGeometry(1.2, 0.08, length);
                    const material = new THREE.MeshLambertMaterial({ color: COLORS_3D.conveyor });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(0, 0.14, z + length/2);

                    // Arrow indicator
                    const arrowGeometry = new THREE.ConeGeometry(0.1, 0.2, 4);
                    const arrowMaterial = new THREE.MeshLambertMaterial({ color: 0xffff00 });
                    const arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
                    arrow.rotation.x = gimmick.direction < 0 ? Math.PI/2 : -Math.PI/2;
                    arrow.position.set(0, 0.2, z + length/2);
                    scene3D.add(arrow);
                    gimmickMeshes.push(arrow);
                    break;
                }

                case 'ElectricFloor': {
                    const length = (gimmick.length || 60) * SCALE_3D;
                    const geometry = new THREE.BoxGeometry(1.4, 0.05, length);
                    const material = new THREE.MeshLambertMaterial({
                        color: COLORS_3D.electric,
                        emissive: COLORS_3D.electric,
                        emissiveIntensity: 0.3
                    });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(0, 0.12, z + length/2);
                    mesh.userData = { type: 'electric' };
                    break;
                }

                case 'PunchingCorridor': {
                    const length = (gimmick.length || 100) * SCALE_3D;
                    const group = new THREE.Group();

                    // Corridor walls
                    const wallGeometry = new THREE.BoxGeometry(0.1, 0.8, length);
                    const wallMaterial = new THREE.MeshLambertMaterial({ color: COLORS_3D.punching });

                    const leftWall = new THREE.Mesh(wallGeometry, wallMaterial);
                    leftWall.position.set(-0.75, 0.4, 0);
                    leftWall.castShadow = true;
                    group.add(leftWall);

                    const rightWall = new THREE.Mesh(wallGeometry, wallMaterial);
                    rightWall.position.set(0.75, 0.4, 0);
                    rightWall.castShadow = true;
                    group.add(rightWall);

                    // Punching gloves
                    const gloveGeometry = new THREE.SphereGeometry(0.15, 8, 8);
                    const gloveMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
                    for (let i = 0; i < 3; i++) {
                        const glove = new THREE.Mesh(gloveGeometry, gloveMaterial);
                        glove.position.set(i % 2 === 0 ? -0.5 : 0.5, 0.4, (i - 1) * length/3);
                        group.add(glove);
                    }

                    group.position.set(0, 0, z + length/2);
                    mesh = group;
                    break;
                }

                case 'RollingBoulder': {
                    const geometry = new THREE.SphereGeometry(0.4, 16, 16);
                    const material = new THREE.MeshLambertMaterial({ color: COLORS_3D.boulder });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(0, 0.5, z);
                    mesh.castShadow = true;
                    mesh.userData = {
                        type: 'boulder',
                        zStart: z,
                        zEnd: (gimmick.zEnd || gimmick.zStart + 100) * SCALE_3D
                    };
                    break;
                }

                case 'DisappearingBridge': {
                    const group = new THREE.Group();
                    const count = gimmick.platformCount || 6;
                    const platWidth = 1.4 / 2;

                    for (let i = 0; i < count; i++) {
                        const platGeometry = new THREE.BoxGeometry(platWidth, 0.1, 0.4);
                        const platMaterial = new THREE.MeshLambertMaterial({
                            color: COLORS_3D.bridge,
                            transparent: true,
                            opacity: 0.8
                        });
                        const plat = new THREE.Mesh(platGeometry, platMaterial);
                        plat.position.x = (i % 2 === 0 ? -1 : 1) * platWidth/2;
                        plat.position.y = 0.15;
                        plat.position.z = i * 0.5;
                        plat.castShadow = true;
                        group.add(plat);
                    }

                    group.position.set(0, 0, z);
                    mesh = group;
                    break;
                }

                default:
                    return null;
            }

            return mesh;
        }

        function animate3D() {
            animationId = requestAnimationFrame(animate3D);

            // Animate rotating bars
            if (animating3D) {
                gimmickMeshes.forEach(mesh => {
                    if (mesh.userData && mesh.userData.type === 'rotating') {
                        mesh.rotation.y += mesh.userData.speed * 0.02;
                    }
                    if (mesh.userData && mesh.userData.type === 'boulder') {
                        const range = mesh.userData.zEnd - mesh.userData.zStart;
                        mesh.position.z = mesh.userData.zStart +
                            (Math.sin(Date.now() * 0.001) * 0.5 + 0.5) * range;
                        mesh.rotation.x += 0.05;
                    }
                    if (mesh.userData && mesh.userData.type === 'electric') {
                        mesh.material.emissiveIntensity = 0.3 + Math.sin(Date.now() * 0.01) * 0.2;
                    }
                });
            }

            controls3D.update();
            renderer3D.render(scene3D, camera3D);
        }

        function set3DCamera(view) {
            const courseLength = parseInt(document.getElementById('courseLength').value) || 2000;
            const trackLength = courseLength * SCALE_3D;
            const centerZ = trackLength / 2;

            // Update button states
            document.querySelectorAll('.preview3d-controls button').forEach(btn => {
                btn.classList.remove('active');
            });

            switch (view) {
                case 'quarter':
                    camera3D.position.set(15, 12, centerZ - 10);
                    document.getElementById('camQuarter').classList.add('active');
                    break;
                case 'top':
                    camera3D.position.set(0, 30, centerZ);
                    document.getElementById('camTop').classList.add('active');
                    break;
                case 'side':
                    camera3D.position.set(20, 5, centerZ);
                    document.getElementById('camSide').classList.add('active');
                    break;
                case 'first':
                    camera3D.position.set(0, 1, 2);
                    document.getElementById('camFirst').classList.add('active');
                    break;
            }

            controls3D.target.set(0, 1, centerZ);
            controls3D.update();
        }

        function reset3DCamera() {
            set3DCamera('quarter');
        }

        function toggle3DAnimation() {
            animating3D = !animating3D;
            const btn = document.getElementById('btnAnimate');
            if (animating3D) {
                btn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                btn.classList.add('active');
            } else {
                btn.textContent = 'â–¶ï¸ ì• ë‹ˆë©”ì´ì…˜';
                btn.classList.remove('active');
            }
        }
    </script>
</body>
</html>
